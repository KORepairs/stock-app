<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Import Products (CSV)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="/app.css">
  <style>
    .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:12px 0}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chip{padding:4px 8px;border-radius:999px;font:12px/1.2 system-ui;border:1px solid var(--border);background:#2b2b2b;color:#ddd}
    .chip.ok{background:#183a1a;color:#cdeccf;border-color:#2f6b33}
    .chip.bad{background:#3a1a1a;color:#f7d7d7;border-color:#6b2f2f}
    .grid{display:grid;grid-template-columns:1fr auto auto auto;gap:12px;align-items:center}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-top:1px solid var(--border);padding:8px}
    th{font-weight:600;text-align:center;background:rgba(255,255,255,.02)}
    td{ text-align:center }
    .log{background:#111;color:#0f0;border-radius:8px;padding:10px;min-height:44px;white-space:pre-wrap}
    @media (max-width:720px){ .grid{grid-template-columns:1fr 1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <aside id="sidebar"></aside>
<main class="page">
  <h1>Import Products (CSV)</h1>

  <div class="toolbar">
    <a href="/products/list"><button>Products list</button></a>
    <a href="/products"><button>Add Single Product</button></a>
  </div>

  <div class="panel">
    <div class="grid">
      <label>
        <input id="file" type="file" accept=".csv,text/csv">
      </label>

      <div style="display:flex;gap:8px;align-items:center;justify-self:end">
        <span>Quantity mode</span>
        <select id="qtyMode">
          <option value="set">Set (overwrite)</option>
          <option value="add">Add (increment)</option>
        </select>
      </div>

      <button id="previewBtn">Preview</button>
      <button id="importBtn">Import</button>
    </div>

    <div style="margin-top:10px;color:#999">
      CSV headers supported:
      <div class="chips" id="headerChips"></div>
      <div style="margin-top:6px;font-size:13px">
        Tip: save as <b>CSV UTF-8 (Comma delimited)</b> from Excel/Sheets.
      </div>
    </div>
  </div>

  <div class="panel" style="margin-top:14px">
    <h3 style="margin:0 0 8px">Preview</h3>
    <table>
      <thead>
        <tr>
          <th>Row</th>
          <th>Action</th>
          <th>SKU</th>
          <th>Name</th>
          <th>Qty</th>
          <th>Notes</th>
          <th>onEbay</th>
          <th>Retail</th>
          <th>Cost</th>
          <th>Fees</th>
          <th>Postage</th>
          <th>Error</th>
        </tr>
      </thead>

      <tbody id="prevBody">
        <tr><td colspan="8" style="padding:10px;text-align:center">Choose a CSV and click Preview.</td></tr>
      </tbody>
    </table>
  </div>

  <div class="panel" style="margin-top:14px">
    <h3 style="margin:0 0 8px">Result</h3>
    <pre class="log" id="log"></pre>
    </div>
  </main>
</div>

<script>
  // ---------- Config: required/optional headers ----------
  const REQUIRED = ['sku','name','quantity'];
  const OPTIONAL = ['notes','onEbay','retail','cost','fees','postage'];
  const ALIASES  = { qty: 'quantity', on_ebay: 'onEbay' }; // friendly alias


  // ---------- Helpers ----------
  const $ = s => document.querySelector(s);
  const log = (msg, clear=false) => {
    const t = $('#log');
    t.textContent = (clear ? '' : (t.textContent ? t.textContent + '\n' : '')) + msg;
  };
  const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  function showHeaderChips(found, checked = false) {
    const wrap = $('#headerChips');
    const all = [...REQUIRED, ...OPTIONAL];
    wrap.innerHTML = all.map(h => {
      const has = (found||[]).includes(h);
      const label = checked
        ? (has ? h : `${h} (missing)`)
        : REQUIRED.includes(h) ? `${h} (required)` : `${h} (optional)`;
      const cls = checked ? (has ? 'ok' : 'bad') : '';
      return `<span class="chip ${cls}">${esc(label)}</span>`;
    }).join('');
  }
  showHeaderChips(null, false); // initial “required/optional” state

  // Simple CSV reader (supports quoted values)
  function parseCSV(text) {
    const rows = [];
    let i=0, field='', row=[], q=false;
    while (i < text.length) {
      const c = text[i++];
      if (q) {
        if (c === '"') {
          if (text[i] === '"') { field += '"'; i++; }
          else q = false;
        } else field += c;
      } else {
        if (c === '"') q = true;
        else if (c === ',') { row.push(field); field=''; }
        else if (c === '\n') { row.push(field); rows.push(row); field=''; row=[]; }
        else if (c === '\r') { /* ignore */ }
        else field += c;
      }
    }
    if (field.length || row.length) { row.push(field); rows.push(row); }
    return rows;
  }

  function headersOf(matrix) {
    if (!matrix.length) return [];
    const heads = matrix[0].map(h => (ALIASES[h.trim().toLowerCase()] || h.trim().toLowerCase()));
    return heads;
  }

  function indexMap(heads) {
    const map = {};
    heads.forEach((h, idx) => { map[h] = idx; });
    return map;
  }

  function needMissing(heads) {
    const missing = REQUIRED.filter(h => !heads.includes(h));
    return missing;
  }

  // ---------- Preview ----------
  let parsed = null;   // matrix of CSV
  let heads   = null;  // normalized headers
  let idx     = null;  // index map

  $('#previewBtn').addEventListener('click', async () => {
    log('', true);
    const f = $('#file').files[0];
    if (!f) { log('Choose a CSV file first.'); return; }

    const text = await f.text();
    const matrix = parseCSV(text).filter(r => r.some(c => String(c).trim() !== '')); // drop empty lines
    if (!matrix.length) { log('CSV appears empty.'); return; }

    parsed = matrix;
    heads  = headersOf(parsed);
    idx    = indexMap(heads);

    showHeaderChips(heads, true);

    const missing = needMissing(heads);
    if (missing.length) {
      $('#prevBody').innerHTML = `<tr><td colspan="8" style="padding:10px;color:#b33;text-align:center">Missing required headers: ${esc(missing.join(', '))}</td></tr>`;
      return;
    }

    // build preview rows
    const body = [];
    for (let r = 1; r < parsed.length; r++) {
      const row = parsed[r];

      const sku   = (row[idx['sku']] ?? '').trim();
      const name  = (row[idx['name']] ?? '').trim();
      const qty   = Number((row[idx['quantity']] ?? '0').trim() || '0') || 0;

      const notes = idx['notes']    != null ? (row[idx['notes']]    ?? '').trim() : '';
      const onEbayRaw = idx['onEbay'] != null ? (row[idx['onEbay']] ?? '').trim() : '';
      const retail = idx['retail']  != null ? Number((row[idx['retail']]  ?? '').trim() || '0') : 0;
      const cost   = idx['cost']    != null ? Number((row[idx['cost']]    ?? '').trim() || '0') : 0;
      const fees   = idx['fees']    != null ? Number((row[idx['fees']]    ?? '').trim() || '0') : 0;
      const postage= idx['postage'] != null ? Number((row[idx['postage']] ?? '').trim() || '0') : 0;


      let error = '';
      if (!sku)  error = 'Missing sku';
      else if (!name) error = 'Missing name';
      else if (Number.isNaN(qty)) error = 'Invalid qty';

      // Decide action: create or update (by SKU); just show label here; real check happens during import.
      const action = 'create/update';

      body.push(`
        <tr>
          <td>${r}</td>
          <td>${action}</td>
          <td>${esc(sku)}</td>
          <td>${esc(name)}</td>
          <td>${qty}</td>
          <td>${esc(notes)}</td>
          <td style="font-weight:600;color:${(/^(1|true|yes|y)$/i).test(onEbayRaw) ? '#7bdc8b' : '#aaa'}">
            ${(/^(1|true|yes|y)$/i).test(onEbayRaw) ? 'Yes' : 'No'}
          </td>
          <td>${retail.toFixed(2)}</td>
          <td>${cost.toFixed(2)}</td>
          <td>${fees.toFixed(2)}</td>
          <td>${postage.toFixed(2)}</td>
          <td style="color:#b33">${esc(error)}</td>
        </tr>
      `);

    }
    $('#prevBody').innerHTML = body.join('') || `<tr><td colspan="8" style="padding:10px;text-align:center">No rows.</td></tr>`;
    log('Preview ready.');
  });

  // ---------- Import ----------
  async function fetchJSON(url, opts) {
    const r = await fetch(url, opts);
    const t = await r.text();
    let j; try { j = JSON.parse(t); } catch {}
    if (!r.ok) throw new Error(j?.error || t || r.statusText);
    return j;
  }

  $('#importBtn').addEventListener('click', async () => {
    log('', true);
    if (!parsed || !heads) { log('Run Preview first.'); return; }

    const missing = needMissing(heads);
    if (missing.length) { log('Cannot import: missing required headers: ' + missing.join(', ')); return; }

    const qtyMode = $('#qtyMode').value; // 'set' or 'add'
    let ok=0, fail=0;

    for (let r = 1; r < parsed.length; r++) {
      const row = parsed[r];

      const skuRaw   = (row[idx['sku']] ?? '').trim();
      const name     = (row[idx['name']] ?? '').trim();
      const qtyRaw   = (row[idx['quantity']] ?? '').trim();
      const qty      = Number(qtyRaw || '0') || 0;
      const notes    = idx['notes']    != null ? (row[idx['notes']]    ?? '').trim() : '';

      const onEbayRaw = idx['onEbay']  != null ? (row[idx['onEbay']]  ?? '').trim() : '';
      const onEbayVal = (/^(1|true|yes|y)$/i).test(String(onEbayRaw)) ? 1 : 0;

      const retail   = idx['retail']   != null ? Number((row[idx['retail']]   ?? '').trim() || '0') : 0;
      const cost     = idx['cost']     != null ? Number((row[idx['cost']]     ?? '').trim() || '0') : 0;
      const fees     = idx['fees']     != null ? Number((row[idx['fees']]     ?? '').trim() || '0') : 0;
      const postage  = idx['postage']  != null ? Number((row[idx['postage']]  ?? '').trim() || '0') : 0;


      if (!skuRaw || !name) { fail++; log(`Row ${r}: skipped — missing sku or name`); continue; }

      try {
        // Check if exists (by SKU)
        const existing = await fetchJSON('/api/products'); // could be optimized, but simple/robust
        const found = existing.find(p => String(p.sku).toUpperCase() === skuRaw.toUpperCase());

        if (!found) {
          // CREATE
          const body = {
            sku: skuRaw,
            name,
            quantity: qty,
            notes: notes || null,
            onEbay: onEbayVal,
            retail, cost, fees, postage
          };
          await fetchJSON('/api/products', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(body)
          });

        } else {
          // UPDATE quantity only according to mode; also update barcode/notes if provided
          const newQty = qtyMode === 'add' ? (Number(found.quantity||0) + qty) : qty;

          const body = {
            sku: skuRaw,
            name,
            quantity: newQty,
            onEbay: onEbayRaw === '' ? !!found.on_ebay : !!onEbayVal,
            retail:  retail  || found.retail  || 0,
            cost:    cost    || found.cost    || 0,
            fees:    fees    || found.fees    || 0,
            postage: postage || found.postage || 0,
            notes:   notes === '' ? (found.notes || null) : (notes || null)
          };

          await fetchJSON('/api/products/' + found.id, {
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(body)
          });

          ok++; log(`Row ${r}: updated ${skuRaw} (qty ${found.quantity} → ${newQty})`);
        }
      } catch (err) {
        fail++; log(`Row ${r}: ERROR — ${err.message}`);
      }
    }

    log(`\nDone. OK: ${ok}, Failed: ${fail}`);
  });

  // initial chips as required/optional
  showHeaderChips(null, false);
</script>
<script src="/js/sidebar.js"></script>
</body>
</html>

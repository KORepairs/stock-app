<!doctype html>
<html lang="en">

<!-- force deploy test -->
    
<head>
  <meta charset="utf-8">
  <title>Refurb Items</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="/app.css">
    <style>
    /* Status colours */
    .refurb-status-strip td,
    td.refurb-status-strip {
      background-color: #4b3b16;  /* brownish */
    }
    .refurb-status-refurb td,
    td.refurb-status-refurb {
      background-color: #12324a;  /* blue-ish */
    }
    .refurb-status-scrap td,
    td.refurb-status-scrap {
      background-color: #7b1d1d;  /* dark red */
    }
    .refurb-status-complete td,
    td.refurb-status-complete {
      background-color: #1f4d2a;  /* green-ish */
    }

    /* Parts status colours (lighter) */
    .refurb-parts-none td,
    td.refurb-parts-none {
      background-color: transparent;
    }
    .refurb-parts-needs_parts td,
    td.refurb-parts-needs_parts {
      background-color: #5a3a1a;  /* amber-ish */
    }
    .refurb-parts-awaiting_parts td,
    td.refurb-parts-awaiting_parts {
      background-color: #5a4a1a;  /* yellow-brown */
    }
    .refurb-parts-has_parts td,
    td.refurb-parts-has_parts {
      background-color: #1f3f2a;  /* dark green */
    }
  </style>
</head>

</head>
<body>
    <div class="wrap">
    <aside id="sidebar"></aside>
  <main class="page">
    <h1>Refurb Items</h1>
    <p style="color:var(--muted,#9aa);margin-top:4px;">
      Track devices going through strip / refurb / scrap and whether they need or are awaiting parts.
    </p>

    <h2 style="margin-top:0">Refurb queue</h2>
    
    <div class="filters" style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;margin:12px 0 14px;">
  <div>
    <label style="display:block;font-size:12px;opacity:.7;margin-bottom:4px;">Search SKU</label>
    <input id="fSku" type="text" placeholder="e.g. L0122" style="min-width:180px;">
  </div>

  <div>
    <label style="display:block;font-size:12px;opacity:.7;margin-bottom:4px;">Status</label>
    <select id="fStatus">
      <option value="">All</option>
      <option value="strip">Strip</option>
      <option value="refurb">Refurb</option>
      <option value="scrap">Scrap</option>
      <option value="complete">Complete</option>
    </select>
  </div>

  <div>
    <label style="display:block;font-size:12px;opacity:.7;margin-bottom:4px;">Supplier</label>
    <select id="fSupplier">
      <option value="">All</option>
      <option value="ITCS">ITCS</option>
      <option value="Dan">Dan</option>
      <option value="Trade-in">Trade-in</option>
    </select>
  </div>

  <div>
    <label style="display:block;font-size:12px;opacity:.7;margin-bottom:4px;">CPU contains</label>
    <input id="fCpu" type="text" placeholder="e.g. i5 / Ryzen" style="min-width:200px;">
  </div>

  <button id="fClear" type="button" style="height:36px;">Clear</button>
</div>


    <!-- Table -->
    <h2 style="margin-top:0">Refurb queue</h2>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th class="col-sku">SKU</th>
            <th>Description</th>
            <th>Status</th>
            <th class="col-parts">Parts</th>
            <th>CPU</th>
            <th>Notes</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="refurbTbody">
          <tr><td colspan="10" style="padding:8px">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </main>

  <script>
  function $(id){ return document.getElementById(id); }
  function esc(s){ return String(s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]||m)); }
  function fmtMoney(v){ return '£' + Number(v || 0).toFixed(2); }

  let __toastTimer;
  function toast(msg, kind='err') {
    let t = document.getElementById('__toast');
    if (!t) {
      t = document.createElement('div');
      t.id = '__toast';
      Object.assign(t.style, {
        position:'fixed',left:'50%',top:'14px',transform:'translateX(-50%)',
        padding:'8px 14px',borderRadius:'999px',fontSize:'13px',
        background:'#a52828',color:'#fff',opacity:'0',transition:'opacity .2s',
        boxShadow:'0 8px 24px rgba(0,0,0,.35)',zIndex:9999,
      });
      document.body.appendChild(t);
    }
    t.style.background = kind==='ok' ? '#2c7a2c' : '#a52828';
    t.textContent = msg;
    t.style.opacity = '1';
    clearTimeout(__toastTimer);
    __toastTimer = setTimeout(()=> t.style.opacity='0', 1800);
  }

    function statusClass(status) {
    switch (status) {
      case 'strip':     return 'refurb-status-strip';
      case 'refurb':    return 'refurb-status-refurb';
      case 'scrap':     return 'refurb-status-scrap';
      case 'complete':  return 'refurb-status-complete';
      default:          return '';
    }
  }

  function partsClass(partsStatus) {
    switch (partsStatus) {
      case 'needs_parts':    return 'refurb-parts-needs_parts';
      case 'awaiting_parts': return 'refurb-parts-awaiting_parts';
      case 'has_parts':      return 'refurb-parts-has_parts';
      case 'none':
      default:               return 'refurb-parts-none';
    }
  }

  let ALL_REFURB = [];



  // -----------------------
  // Load refurb items (fetch once, then filter client-side)
  // -----------------------
  async function loadRefurb() {
    const tbody = $('refurbTbody');
    tbody.innerHTML = '<tr><td colspan="10" style="padding:8px">Loading…</td></tr>';

    try {
      const res = await fetch('/api/refurb');
      const items = await res.json();

      ALL_REFURB = Array.isArray(items) ? items : [];

      populateFilters(ALL_REFURB);
      applyFilters();

    } catch (e) {
      console.error(e);
      tbody.innerHTML = '<tr><td colspan="10" style="padding:8px;color:#900">Failed to load refurb items</td></tr>';
    }
  }

  function populateFilters(items) {
  const supplierSel = $('supplierFilter');
  const cpuSel = $('cpuFilter');

  // Keep the "All ..." option, clear the rest
  supplierSel.innerHTML = '<option value="">All suppliers</option>';
  cpuSel.innerHTML = '<option value="">All CPUs</option>';

  const suppliers = [...new Set(items.map(x => (x.supplier || '').trim()).filter(Boolean))].sort();
  const cpus = [...new Set(items.map(x => (x.cpu || '').trim()).filter(Boolean))].sort();

  suppliers.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s;
    opt.textContent = s;
    supplierSel.appendChild(opt);
  });

  cpus.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    cpuSel.appendChild(opt);
  });
}

function applyFilters() {
  const qSku = ($('skuSearch')?.value || '').trim().toUpperCase();
  const fStatus = $('statusFilter')?.value || '';
  const fSupplier = ($('supplierFilter')?.value || '').trim();
  const fCpu = ($('cpuFilter')?.value || '').trim();

  const filtered = ALL_REFURB.filter(item => {
    const sku = String(item.sku || '').toUpperCase();
    const status = String(item.status || '');
    const supplier = String(item.supplier || '').trim();
    const cpu = String(item.cpu || '').trim();

    if (qSku && !sku.includes(qSku)) return false;
    if (fStatus && status !== fStatus) return false;
    if (fSupplier && supplier !== fSupplier) return false;
    if (fCpu && cpu !== fCpu) return false;

    return true;
  });

  renderRefurbTable(filtered);
}

function renderRefurbTable(items) {
  const tbody = $('refurbTbody');

  if (!Array.isArray(items) || items.length === 0) {
    tbody.innerHTML = '<tr><td colspan="10" style="padding:8px">No matching refurb items.</td></tr>';
    return;
  }

  tbody.innerHTML = items.map(item => {
    return `<tr>
      <td class="col-sku">
        <input data-id="${item.id}" class="skuInp" type="text" value="${esc(item.sku)}">
      </td>

      <td>${esc(item.description)}</td>

      <td class="${statusClass(item.status)}">
        <select data-id="${item.id}" class="statusSel">
          <option value="strip" ${item.status==='strip'?'selected':''}>Strip</option>
          <option value="refurb" ${item.status==='refurb'?'selected':''}>Refurb</option>
          <option value="scrap" ${item.status==='scrap'?'selected':''}>Scrap</option>
          <option value="complete" ${item.status==='complete'?'selected':''}>Complete</option>
        </select>
      </td>

      <td class="col-parts ${partsClass(item.parts_status)}">
        <select data-id="${item.id}" class="partsSel">
          <option value="none" ${item.parts_status==='none'?'selected':''}>None</option>
          <option value="needs_parts" ${item.parts_status==='needs_parts'?'selected':''}>Needs parts</option>
          <option value="awaiting_parts" ${item.parts_status==='awaiting_parts'?'selected':''}>Awaiting parts</option>
          <option value="has_parts" ${item.parts_status==='has_parts'?'selected':''}>Has parts</option>
        </select>
      </td>

      <td>
        <input data-id="${item.id}" class="cpuInp" type="text"
          value="${esc(item.cpu || '')}" placeholder="e.g. i5-10210U">
      </td>

      <td>
        <input data-id="${item.id}" class="notesInp" type="text" value="${esc(item.notes)}">
      </td>

      <td>
        <button type="button" class="detailBtn" data-id="${item.id}">Details</button>
        <button type="button" class="saveRowBtn" data-id="${item.id}">Save</button>
        <button type="button" class="deleteRowBtn" data-id="${item.id}" style="margin-left:6px;">Delete</button>
      </td>
    </tr>`;
  }).join('');

  // re-wire after render
  wireRefurbDropdowns();
  wireRefurbRowSaves();
  wireRefurbDeletes();
  wireRefurbDetails();
}



  
  // -----------------------
  // Wire dropdown updates
  // -----------------------
  function wireRefurbDropdowns() {
    document.querySelectorAll('.statusSel, .partsSel').forEach(sel => {
      sel.addEventListener('change', async () => {

        const id = sel.getAttribute('data-id');
        const row = sel.closest('tr');

        const statusSel = row.querySelector('.statusSel');
        const partsSel  = row.querySelector('.partsSel');

        const body = {
          status: statusSel.value,
          parts_status: partsSel.value
        };

        try {
          const res = await fetch(`/api/refurb/${id}`, {
            method: 'PUT',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(body)
          });

          if (!res.ok) throw new Error('Update failed');

          toast('Updated ✔️', 'ok');

        } catch (err) {
          console.error(err);
          toast('Failed to update');
        }
      });
    });
  }

    function wireRefurbRowSaves() {
    document.querySelectorAll('.saveRowBtn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-id');
        const row = btn.closest('tr');

        const skuEl      = row.querySelector('.skuInp');
        const statusSel  = row.querySelector('.statusSel');
        const partsSel   = row.querySelector('.partsSel');
        const cpuEl = row.querySelector('.cpuInp');
        const notesEl    = row.querySelector('.notesInp');

        const body = {
            sku: skuEl.value.trim() || null,
            cpu: cpuEl.value.trim() || null,
            status: statusSel.value,
            parts_status: partsSel.value,
            notes: notesEl.value.trim() || null,
            };



        btn.disabled = true;
        btn.textContent = 'Saving…';

        try {
          const res = await fetch(`/api/refurb/${id}`, {
            method: 'PUT',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(body),
          });

          if (!res.ok) throw new Error('Failed to save row');

          toast('Row updated ✔️', 'ok');
        } catch (err) {
          console.error(err);
          toast('Failed to update row');
        } finally {
          btn.disabled = false;
          btn.textContent = 'Save';
        }
      });
    });
  }

    function wireRefurbDeletes() {
    document.querySelectorAll('.deleteRowBtn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-id');
        if (!confirm('Delete this refurb item?')) return;

        btn.disabled = true;
        btn.textContent = 'Deleting…';

        try {
          const res = await fetch(`/api/refurb/${id}`, {
            method: 'DELETE'
          });

          if (!res.ok) throw new Error('Failed to delete refurb');

          const data = await res.json();
          if (!data.deleted) throw new Error('Refurb not found / not deleted');

          // Remove the row from the table
          const row = btn.closest('tr');
          if (row) row.remove();

          toast('Refurb deleted ✔️', 'ok');
        } catch (err) {
          console.error(err);
          toast(err.message || 'Failed to delete refurb');
        }
      });
    });
  }

  function wireRefurbDetails() {
  document.querySelectorAll('.detailBtn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-id');
      window.location.href = `/refurb/${id}`;
    });
  });
}

['skuSearch','statusFilter','supplierFilter','cpuFilter'].forEach(id => {
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener('input', applyFilters);
  el.addEventListener('change', applyFilters);
});

document.getElementById('clearFilters')?.addEventListener('click', () => {
  $('skuSearch').value = '';
  $('statusFilter').value = '';
  $('supplierFilter').value = '';
  $('cpuFilter').value = '';
  applyFilters();
});


  // Load table on page open
  window.addEventListener('DOMContentLoaded', loadRefurb);
</script>
<script src="/js/sidebar.js"></script>
</body>
</html>

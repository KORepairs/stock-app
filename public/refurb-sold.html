<!doctype html>
<html lang="en">

<!-- force deploy test -->
    
<head>
  <meta charset="utf-8">
  <title>Refurb Sold</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="/app.css">
    <style>
    /* ===== Status colours (strong) ===== */
  td.refurb-status-strip    { background:#ed9507; } /* strip = brown */
  td.refurb-status-refurb   { background:#0819d1; } /* refurb = blue */
  td.refurb-status-scrap    { background:#e81c0e; } /* scrap = red */
  td.refurb-status-complete { background:#158207; } /* complete = green */

  /* ===== Parts colours (softer, but still visible) ===== */
  td.refurb-parts-none           { background:#919087; }
  td.refurb-parts-needs_parts    { background:#a81703; } /* red */
  td.refurb-parts-awaiting_parts { background:#d9c61e; } /* yellow-brown */
  td.refurb-parts-has_parts      { background:#053802; } /* dark green */

  /* Optional: make dropdowns readable on coloured cells */
  td.refurb-status-strip select,
  td.refurb-status-refurb select,
  td.refurb-status-scrap select,
  td.refurb-status-complete select,
  td.refurb-parts-needs_parts select,
  td.refurb-parts-awaiting_parts select,
  td.refurb-parts-has_parts select {
    background: #fff;
  }

  /* --- Make the coloured "pill" --- */
  .pill {
    display: inline-flex;
    align-items: center;
    border-radius: 999px;
    padding: 6px 10px;
    min-height: 34px;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
  }

  /* Make the select sit nicely inside the pill */
  .pill select {
    border: 0;
    outline: none;
    background: transparent;
    color: #fff;
    font-weight: 600;
    padding: 0 6px;
    min-height: 22px;
    cursor: pointer;
  }

  /* Remove the big coloured TD backgrounds (optional safety) */
  td.refurb-status-strip,
  td.refurb-status-refurb,
  td.refurb-status-scrap,
  td.refurb-status-complete,
  td.refurb-parts-none,
  td.refurb-parts-needs_parts,
  td.refurb-parts-awaiting_parts,
  td.refurb-parts-has_parts {
    background: transparent !important;
  }

  /* ===== Status pill colours ===== */
  .pill-status-strip    { background:#ed9507; }
  .pill-status-refurb   { background:#0819d1; }
  .pill-status-scrap    { background:#e81c0e; }
  .pill-status-complete { background:#158207; }

  /* ===== Parts pill colours ===== */
  .pill-parts-none           { background: #919087; }
  .pill-parts-needs_parts    { background:#a81703; }
  .pill-parts-awaiting_parts { background:#d9c61e; }
  .pill-parts-has_parts      { background:#053802; }

  .table-wrap table {
  width: 100%;
  table-layout: fixed;
}

.table-wrap th,
.table-wrap td {
  vertical-align: middle;
}

.table-wrap input,
.table-wrap select {
  width: 100%;
  min-width: 0;
  box-sizing: border-box;
}

.col-sku { width: 110px; }
.col-desc { width: 240px; }
.col-status { width: 150px; }
.col-parts { width: 150px; }
.col-retail { width: 120px; }
.col-cpu { width: 170px; }
.col-notes { width: 260px; }
.col-actions { width: 240px; }

.col-actions .actions {
  display: flex;
  gap: 6px;
  justify-content: flex-end;
  flex-wrap: nowrap;
}

.col-actions button {
  white-space: nowrap;
}

.table-wrap th,
.table-wrap td {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

  </style>
</head>

<body>
    <div class="wrap">
    <aside id="sidebar"></aside>
  <main class="page">
    <h1>Refurb Sold</h1>
    <p style="color:var(--muted,#9aa);margin-top:4px;">
      Track devices going through strip / refurb / scrap and whether they need or are awaiting parts.
    </p>

    <h2 style="margin-top:0">Sold Refurb Items</h2>
    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
  <a href="/refurb/complete"><button>Back to complete</button></a>
    
    <div class="filters" style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;margin:12px 0 14px;">
        <div>
            <label style="display:block;font-size:12px;opacity:.7;margin-bottom:4px;">Search SKU</label>
            <input id="fSku" type="text" placeholder="e.g. L0122" style="min-width:180px;">
        </div>

        <div>
            <label style="display:block;font-size:12px;opacity:.7;margin-bottom:4px;">View</label>
            <select id="fView">
            <option value="computer">Laptop + PC</option>
            <option value="phone">Phones</option>
            <option value="tablet">Tablets</option>
            <option value="console">Consoles</option>
            </select>
        </div>

        <div>
            <label style="display:block;font-size:12px;opacity:.7;margin-bottom:4px;">Status</label>
            <select class="statusSel">
  <option value="complete">Complete</option>
  <option value="sold">Sold</option>
</select>
        </div>


        <!-- Computer filter -->
        <div id="filterComputer">
            <label style="display:block;font-size:12px;opacity:.7;margin-bottom:4px;">CPU contains</label>
            <input id="fCpu" type="text" placeholder="e.g. i5 / Ryzen" style="min-width:200px;">
        </div>

        <!-- Phone/Tablet filters -->
        <div id="filterMobile" style="display:none;">
            <label style="display:block;font-size:12px;opacity:.7;margin-bottom:4px;">Colour contains</label>
        <input id="fColour" type="text" placeholder="e.g. Black" style="min-width:160px;">
        </div>

        <div id="filterMobile2" style="display:none;">
            <label style="display:block;font-size:12px;opacity:.7;margin-bottom:4px;">Storage contains</label>
            <input id="fStorage" type="text" placeholder="e.g. 128GB" style="min-width:160px;">
        </div>

        <!-- Console filters -->
        <div id="filterConsole" style="display:none;">
            <label style="display:block;font-size:12px;opacity:.7;margin-bottom:4px;">Storage contains</label>
            <input id="fStorageConsole" type="text" placeholder="e.g. 1TB" style="min-width:160px;">
        </div>

        <div id="filterConsole2" style="display:none;">
            <label style="display:block;font-size:12px;opacity:.7;margin-bottom:4px;">Controller contains</label>
            <input id="fController" type="text" placeholder="e.g. Yes / No / 2" style="min-width:160px;">
        </div>

        <button id="fClear" type="button" style="height:36px;">Clear</button>
        </div>

        <div class="table-wrap">
        <table>
            <thead id="refurbThead"></thead>
            <tbody id="refurbTbody">
            <tr><td colspan="20" style="padding:8px">Loading…</td></tr>
            </tbody>
        </table>
        </div>
    </div>
  </main>

  <script>
  function $(id){ return document.getElementById(id); }
  function setVal(id, v) {
    const el = document.getElementById(id);
    if (el) el.value = v;
  }

  function esc(s){ return String(s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]||m)); }
  function fmtMoney(v){ return '£' + Number(v || 0).toFixed(2); }

  let __toastTimer;
  function toast(msg, kind='err') {
    let t = document.getElementById('__toast');
    if (!t) {
      t = document.createElement('div');
      t.id = '__toast';
      Object.assign(t.style, {
        position:'fixed',left:'50%',top:'14px',transform:'translateX(-50%)',
        padding:'8px 14px',borderRadius:'999px',fontSize:'13px',
        background:'#a52828',color:'#fff',opacity:'0',transition:'opacity .2s',
        boxShadow:'0 8px 24px rgba(0,0,0,.35)',zIndex:9999,
      });
      document.body.appendChild(t);
    }
    t.style.background = kind==='ok' ? '#2c7a2c' : '#a52828';
    t.textContent = msg;
    t.style.opacity = '1';
    clearTimeout(__toastTimer);
    __toastTimer = setTimeout(()=> t.style.opacity='0', 1800);
  }

    function statusClass(status) {
  switch (status) {
    case 'strip': return 'refurb-status-strip';
    case 'refurb': return 'refurb-status-refurb';
    case 'scrap': return 'refurb-status-scrap';
    case 'complete': return 'refurb-status-complete';
    default: return '';
  }
}

function partsClass(partsStatus) {
  switch (partsStatus) {
    case 'needs_parts': return 'refurb-parts-needs_parts';
    case 'awaiting_parts': return 'refurb-parts-awaiting_parts';
    case 'has_parts': return 'refurb-parts-has_parts';
    case 'none':
    default: return 'refurb-parts-none';
  }
}

function statusPillClass(status) {
  switch (status) {
    case 'strip':
    case 'stripped':
      return 'pill-status-strip';

    case 'scrap':
    case 'scrapped':
      return 'pill-status-scrap';

    case 'complete':
      return 'pill-status-complete';

    case 'refurb':
    default:
      return 'pill-status-refurb';
  }
}


function partsPillClass(partsStatus) {
  switch (partsStatus) {
    case 'needs_parts':    return 'pill-parts-needs_parts';
    case 'awaiting_parts': return 'pill-parts-awaiting_parts';
    case 'has_parts':      return 'pill-parts-has_parts';
    case 'none':
    default:               return 'pill-parts-none';
  }
}

function updateLocalRefurb(updatedRow) {
  if (!updatedRow || !updatedRow.id) return;
  const idx = ALL_REFURB.findIndex(x => String(x.id) === String(updatedRow.id));
  if (idx >= 0) {
    ALL_REFURB[idx] = { ...ALL_REFURB[idx], ...updatedRow };
  }
}

function removeLocalRefurb(id) {
  ALL_REFURB = ALL_REFURB.filter(x => String(x.id) !== String(id));
}


  let ALL_REFURB = [];

const path = window.location.pathname;
const isCompletePage = path === '/refurb/complete';
const isSoldPage = path === '/refurb/sold';

  // -----------------------
  // Load refurb items (fetch once, then filter client-side)
  // -----------------------
  async function loadRefurb() {
  const tbody = $('refurbTbody');
  tbody.innerHTML = '<tr><td colspan="20">Loading…</td></tr>';

  try {
    let url = '/api/refurb?view=active';
    if (isCompletePage) url = '/api/refurb?view=complete';
    if (isSoldPage) url = '/api/refurb?view=sold';

    const res = await fetch(url, { cache: 'no-store' });
    const items = await res.json();

    ALL_REFURB = Array.isArray(items) ? items : [];

    syncViewUI();
    populateFilters(ALL_REFURB);
    applyFilters();

  } catch (e) {
    console.error(e);
    tbody.innerHTML =
      '<tr><td colspan="20" style="color:red">Failed to load refurb items</td></tr>';
  }
}

  function populateFilters(items) {
  // (your supplier list is fixed in HTML, so we don’t need to populate it)
  // But we *can* still populate supplier dynamically if you want later.

  // CPU dropdown doesn’t exist (you’re using a text input fCpu), so nothing to populate
}


  function applyFilters() {
  const qSku = ($('fSku')?.value || '').trim().toUpperCase();
  const fStatus = $('fStatus')?.value || '';
  const fParts = ($('fParts')?.value || '').trim();

  const view = $('fView')?.value || 'computer';
  const cfg = getViewConfig(view);

  // View-specific filters
  const fCpu = ($('fCpu')?.value || '').trim().toLowerCase();

  const fColour = ($('fColour')?.value || '').trim().toLowerCase();
  const fStorage = ($('fStorage')?.value || '').trim().toLowerCase();

  const fStorageConsole = ($('fStorageConsole')?.value || '').trim().toLowerCase();
  const fController = ($('fController')?.value || '').trim().toLowerCase();

  const filtered = ALL_REFURB.filter(item => {
    const sku = String(item.sku || '').toUpperCase();
    const status = String(item.status || '');
    const parts = String(item.parts_status || '').trim();
    const category = (String(item.category || '').trim().toLowerCase() || 'laptop');

    // lock to current view categories
    if (!cfg.categories.includes(category)) return false;

    if (qSku && !sku.includes(qSku)) return false;
    if (fStatus && status !== fStatus) return false;
    if (fParts && parts !== fParts) return false;

    if (view === 'computer') {
      const cpu = String(item.cpu || '').trim().toLowerCase();
      if (fCpu && !cpu.includes(fCpu)) return false;
    }

    if (view === 'phone' || view === 'tablet') {
      const colour = String(item.colour || '').trim().toLowerCase();
      const storage = String(item.storage || '').trim().toLowerCase();
      if (fColour && !colour.includes(fColour)) return false;
      if (fStorage && !storage.includes(fStorage)) return false;
    }

    if (view === 'console') {
      const storage = String(item.storage || '').trim().toLowerCase();
      const controller = String(item.controller || '').trim().toLowerCase();
      if (fStorageConsole && !storage.includes(fStorageConsole)) return false;
      if (fController && !controller.includes(fController)) return false;
    }

    return true;
  });

  renderRefurbTable(filtered);
}

 function clearFilters() {
  setVal('fSku', '');
  setVal('fStatus', '');
  setVal('fParts', '');

  // computer
  setVal('fCpu', '');

  // phone / tablet
  setVal('fColour', '');
  setVal('fStorage', '');

  // console
  setVal('fStorageConsole', '');
  setVal('fController', '');

  applyFilters();
}


function syncViewUI() {
  const view = $('fView')?.value || 'computer';

  // Show/hide filter blocks
  $('filterComputer').style.display = (view === 'computer') ? '' : 'none';
  $('filterMobile').style.display   = (view === 'phone' || view === 'tablet') ? '' : 'none';
  $('filterMobile2').style.display  = (view === 'phone' || view === 'tablet') ? '' : 'none';
  $('filterConsole').style.display  = (view === 'console') ? '' : 'none';
  $('filterConsole2').style.display = (view === 'console') ? '' : 'none';
}


    function getViewConfig(view) {
  const baseCols = [
    {
      label: 'SKU',
      thClass: 'col-sku',
      render: (item) => `
        <a href="/refurb/${item.id}" class="skuLink" title="View refurb details">
          ${esc(item.sku)}
        </a>
      `
    },
    {
  label: 'Description',
  thClass: 'col-description',
  render: (item) => `
    <input data-id="${item.id}" class="descInp" type="text"
      value="${esc(item.description || '')}" placeholder="Description">
  `
},

    {
      label: 'Category',
      thClass: 'col-category',
      render: (item) => `
        <select data-id="${item.id}" class="catSel">
          <option value="laptop" ${item.category==='laptop'?'selected':''}>Laptop</option>
          <option value="pc" ${item.category==='pc'?'selected':''}>PC</option>
          <option value="phone" ${item.category==='phone'?'selected':''}>Phone</option>
          <option value="tablet" ${item.category==='tablet'?'selected':''}>Tablet</option>
          <option value="console" ${item.category==='console'?'selected':''}>Console</option>
        </select>
      `
    },
    {
      label: 'Status',
      thClass: 'col-status',
      render: (item) => `
        <span class="pill ${statusPillClass(item.status)}">
          <select data-id="${item.id}" class="statusSel">
            <option value="strip"     ${item.status==='strip'?'selected':''}>Strip</option>
            <option value="stripped"  ${item.status==='stripped'?'selected':''}>Stripped</option>

            <option value="refurb"    ${item.status==='refurb'?'selected':''}>Refurb</option>

            <option value="scrap"     ${item.status==='scrap'?'selected':''}>Scrap</option>
            <option value="scrapped"  ${item.status==='scrapped'?'selected':''}>Scrapped</option>

            <option value="complete"  ${item.status==='complete'?'selected':''}>Complete</option>
          </select>

        </span>
      `
    },
    {
      label: 'Parts',
      thClass: 'col-parts',
      render: (item) => `
        <span class="pill ${partsPillClass(item.parts_status)}">
          <select data-id="${item.id}" class="partsSel">
            <option value="none" ${item.parts_status==='none'?'selected':''}>None</option>
            <option value="needs_parts" ${item.parts_status==='needs_parts'?'selected':''}>Needs parts</option>
            <option value="awaiting_parts" ${item.parts_status==='awaiting_parts'?'selected':''}>Awaiting parts</option>
            <option value="has_parts" ${item.parts_status==='has_parts'?'selected':''}>Has parts</option>
          </select>
        </span>
      `
    },

    {
  label: 'Retail (£)',
  thClass: 'col-retail',
  render: (item) => `
    <input data-id="${item.id}" class="retailInp" type="number"
      step="0.01" min="0"
      value="${Number(item.retail || 0).toFixed(2)}">
  `
},
  ];



  const actionsCol = {
  label: 'Actions',
  thClass: 'col-actions',
  render: (item) => `
    <div class="actions">
      <button type="button" class="detailBtn" data-id="${item.id}">Details</button>
      <button type="button" class="saveRowBtn" data-id="${item.id}">Save</button>
      <button type="button" class="deleteRowBtn" data-id="${item.id}">Delete</button>
    </div>
  `
};

  if (view === 'computer') {
    return {
      categories: ['laptop', 'pc'],
      cols: [
        ...baseCols,
        {
          label: 'CPU',
          thClass: 'col-cpu',
          render: (item) => `
            <input data-id="${item.id}" class="cpuInp" type="text"
              value="${esc(item.cpu || '')}" placeholder="e.g. i5-10210U">
          `
        },
        {
          label: 'Notes',
          thClass: 'col-notes',
          render: (item) => `
            <input data-id="${item.id}" class="notesInp" type="text"
              value="${esc(item.notes || '')}">
          `
        },
        actionsCol
      ]
    };
  }

  if (view === 'phone' || view === 'tablet') {
    return {
      categories: [view],
      cols: [
        ...baseCols,
        {
          label: 'Colour',
          render: (item) => `
            <input data-id="${item.id}" class="colourInp" type="text"
              value="${esc(item.colour || '')}" placeholder="e.g. Black">
          `
        },
        {
          label: 'Storage',
          render: (item) => `
            <input data-id="${item.id}" class="storageInp" type="text"
              value="${esc(item.storage || '')}" placeholder="e.g. 128GB">
          `
        },
        actionsCol
      ]
    };
  }

  // console view
  return {
    categories: ['console'],
    cols: [
      ...baseCols,
      {
        label: 'Storage',
        render: (item) => `
          <input data-id="${item.id}" class="storageInp" type="text"
            value="${esc(item.storage || '')}" placeholder="e.g. 1TB">
        `
      },
      {
        label: 'Controller',
        render: (item) => `
          <input data-id="${item.id}" class="controllerInp" type="text"
            value="${esc(item.controller || '')}" placeholder="e.g. Yes / No / 2">
        `
      },
      actionsCol
    ]
  };
}

function renderHeader(cfg) {
  const thead = document.getElementById('refurbThead');
  thead.innerHTML = `
    <tr>
      ${cfg.cols.map(c => `<th class="${c.thClass || ''}">${c.label}</th>`).join('')}
    </tr>
  `;
}


function renderRefurbTable(items) {
  const tbody = $('refurbTbody');

  const view = document.getElementById('fView')?.value || 'computer';
  const cfg = getViewConfig(view);

  // build the header for this view
  renderHeader(cfg);

  if (!Array.isArray(items) || items.length === 0) {
    tbody.innerHTML = '<tr><td colspan="20" style="padding:8px">No matching refurb items.</td></tr>';
    return;
  }

  tbody.innerHTML = items.map(item => `
    <tr>
      ${cfg.cols.map(c => `<td class="${c.thClass || ''}">${c.render(item)}</td>`).join('')}
    </tr>
  `).join('');

  wireRefurbDropdowns();
  wireRefurbRowSaves();
  wireRefurbDeletes();
  wireRefurbDetails();
}




  
  // -----------------------
  // Wire dropdown updates
  // -----------------------
  function wireRefurbDropdowns() {
  document.querySelectorAll('.statusSel, .partsSel, .catSel').forEach(sel => {
    sel.addEventListener('change', async () => {

      const id = sel.getAttribute('data-id');
      const row = sel.closest('tr');

      const statusSel = row.querySelector('.statusSel');
      const partsSel  = row.querySelector('.partsSel');

      // ✅ update pill colours immediately
      const statusPill = statusSel.closest('.pill');
      const partsPill  = partsSel.closest('.pill');

      statusPill.className = `pill ${statusPillClass(statusSel.value)}`;
      partsPill.className  = `pill ${partsPillClass(partsSel.value)}`;

      const catSel = row.querySelector('.catSel');

      const body = {
        status: statusSel.value,
        parts_status: partsSel.value,
        category: catSel?.value || null
      };

      try {
        const res = await fetch(`/api/refurb/${id}`, {
          method: 'PUT',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });

        if (!res.ok) throw new Error('Update failed');

        // ✅ IMPORTANT: update the in-memory list so rerender doesn't snap back
        const updatedRow = await res.json();
        updateLocalRefurb(updatedRow);

        if (updatedRow.status === 'scrapped' || updatedRow.status === 'stripped') {
          removeLocalRefurb(updatedRow.id);
        }


        toast('Updated ✔️', 'ok');
        applyFilters();

      } catch (err) {
        console.error(err);
        toast('Failed to update');
      }
    });
  });
}



    function wireRefurbRowSaves() {
  document.querySelectorAll('.saveRowBtn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.getAttribute('data-id');
      const row = btn.closest('tr');
      


      const statusSel = row.querySelector('.statusSel');
      const partsSel  = row.querySelector('.partsSel');
      const catSel    = row.querySelector('.catSel');
      const descEl = row.querySelector('.descInp');
      const retailEl = row.querySelector('.retailInp');


      const view = $('fView')?.value || 'computer';

      // Base payload (always save these)
      const body = {
        category: catSel?.value || null,
        status: statusSel?.value || 'refurb',
        parts_status: partsSel?.value || 'none',
        description: descEl?.value.trim() || null,
      };

      body.retail = retailEl ? Number(retailEl.value || 0) : 0;

      // View-specific fields
      if (view === 'computer') {
        const cpuEl   = row.querySelector('.cpuInp');
        const notesEl = row.querySelector('.notesInp');
        body.cpu   = cpuEl?.value.trim() || null;
        body.notes = notesEl?.value.trim() || null;
        

      }

      if (view === 'phone' || view === 'tablet') {
        const colourEl  = row.querySelector('.colourInp');
        const storageEl = row.querySelector('.storageInp');
        body.colour  = colourEl?.value.trim() || null;
        body.storage = storageEl?.value.trim() || null;
      }

      if (view === 'console') {
        const storageEl    = row.querySelector('.storageInp');
        const controllerEl = row.querySelector('.controllerInp');
        body.storage    = storageEl?.value.trim() || null;
        body.controller = controllerEl?.value.trim() || null;
      }

      btn.disabled = true;
      btn.textContent = 'Saving…';

      try {
        const res = await fetch(`/api/refurb/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        if (!res.ok) throw new Error('Failed to save row');
        const updatedRow = await res.json();
        updateLocalRefurb(updatedRow);

        if (updatedRow.status === 'scrapped' || updatedRow.status === 'stripped') {
          removeLocalRefurb(updatedRow.id);
        }


        toast('Row updated ✔️', 'ok');
        applyFilters();


      } catch (err) {
        console.error(err);
        toast('Failed to update row');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save';
      }
    });
  });
}


    function wireRefurbDeletes() {
    document.querySelectorAll('.deleteRowBtn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-id');
        if (!confirm('Delete this refurb item?')) return;

        btn.disabled = true;
        btn.textContent = 'Deleting…';

        try {
          const res = await fetch(`/api/refurb/${id}`, {
            method: 'DELETE'
          });

          if (!res.ok) throw new Error('Failed to delete refurb');

          const data = await res.json();
          if (!data.deleted) throw new Error('Refurb not found / not deleted');

          // Remove the row from the table
          const row = btn.closest('tr');
          if (row) row.remove();

          toast('Refurb deleted ✔️', 'ok');
        } catch (err) {
          console.error(err);
          toast(err.message || 'Failed to delete refurb');
        }
      });
    });
  }

  function wireRefurbDetails() {
  document.querySelectorAll('.detailBtn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-id');
      window.location.href = `/refurb/${id}`;
    });
  });
}

['fSku','fStatus','fParts','fCpu','fColour','fStorage','fStorageConsole','fController'].forEach(id => {
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener('input', applyFilters);
  el.addEventListener('change', applyFilters);
});

function applyQueryFilters() {
  const params = new URLSearchParams(location.search);

  const view = params.get('view');     // computer | phone | tablet | console
  const status = params.get('status'); // strip | refurb | complete | scrap etc
  const parts = params.get('parts');   // none | needs_parts | awaiting_parts | has_parts
  const sku = params.get('sku');       // partial SKU search

  if (view && $('fView')) $('fView').value = view;
  syncViewUI();

  if (status && $('fStatus')) $('fStatus').value = status;
  if (parts && $('fParts')) $('fParts').value = parts;
  if (sku && $('fSku')) $('fSku').value = sku;

  applyFilters();
}



$('fView')?.addEventListener('change', () => {
  syncViewUI();
  applyFilters();
});



  // Load table on page open
  window.addEventListener('DOMContentLoaded', async () => {
  syncViewUI();
  await loadRefurb();      // wait for ALL_REFURB to load
  applyQueryFilters();     // then apply URL filters

  const btn = document.getElementById('fClear');
  if (btn) btn.addEventListener('click', clearFilters);
});


</script>
<script src="/js/sidebar.js"></script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Trade-In</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="/app.css">
</head>
<body>
    <div class="wrap">
    <aside id="sidebar"></aside>
  <div class="page">
    <h1>Trade-In</h1>
    <p style="color:var(--muted,#9aa);margin-top:4px;">
      Record customer trade-ins and optionally create a refurb record automatically.
    </p>

    <form id="tradeForm" class="form-grid" style="margin-top:16px;" enctype="multipart/form-data">
      <label for="customer_name">Customer name</label>
      <input id="customer_name" name="customer_name" type="text" required>

      <label for="customer_phone">Phone</label>
      <input id="customer_phone" name="customer_phone" type="tel">

      <label for="customer_email">Email</label>
      <input id="customer_email" name="customer_email" type="email">

      <label for="serial">Serial / IMEI</label>
      <input id="serial" name="serial" type="text">

      <label for="device_desc">Device description</label>
      <input id="device_desc" name="device_desc" type="text" required placeholder="e.g. iPhone 13 128GB Black">

      <label for="valuation">Valuation (£)</label>
      <input id="valuation" name="valuation" type="number" step="0.01" min="0">

      <label for="agreed_value">Agreed value (£)</label>
      <input id="agreed_value" name="agreed_value" type="number" step="0.01" min="0">

      <label for="id_image">ID image (photo of ID)</label>
      <input id="id_image" name="id_image" type="file" accept="image/*">

      <div class="full" style="margin-top:8px;">
        <label style="display:flex;gap:8px;align-items:center;">
          <input type="checkbox" name="create_refurb" checked>
          <span>Create refurb record for this device</span>
        </label>
      </div>

      <div class="full">
        <button id="tradeSubmit" type="submit">Save Trade-In</button>
      </div>
    </form>
  </div>

  <script>
    function toast(msg, kind='err') {
      let t = document.getElementById('__toast');
      if (!t) {
        t = document.createElement('div');
        t.id = '__toast';
        Object.assign(t.style, {
          position:'fixed',left:'50%',top:'14px',transform:'translateX(-50%)',
          padding:'8px 14px',borderRadius:'999px',fontSize:'13px',
          background:'#a52828',color:'#fff',opacity:'0',transition:'opacity .2s',
          boxShadow:'0 8px 24px rgba(0,0,0,.35)',zIndex:9999,
        });
        document.body.appendChild(t);
      }
      t.style.background = kind==='ok' ? '#2c7a2c' : '#a52828';
      t.textContent = msg;
      t.style.opacity = '1';
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=> t.style.opacity='0', 1800);
    }

    const form = document.getElementById('tradeForm');
    const btn  = document.getElementById('tradeSubmit');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const fd = new FormData(form);

      btn.disabled = true;
      btn.textContent = 'Saving…';

      try {
        const res = await fetch('/api/tradein', {
          method: 'POST',
          body: fd,
        });

        const text = await res.text();
        if (!res.ok) {
          let msg = 'Failed to save trade-in';
          try {
            const j = JSON.parse(text);
            msg = j.error || msg;
          } catch {}
          throw new Error(msg);
        }

        toast('Trade-in saved ✔️', 'ok');
        form.reset();
      } catch (err) {
        console.error(err);
        toast(err.message || 'Failed to save trade-in');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save Trade-In';
      }
    });
  </script>
  <script src="/js/sidebar.js"></script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Trade-In List</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="/app.css">
</head>
<body>
  <div class="page">
    <h1>Trade-Ins</h1>
    <p style="color:var(--muted,#9aa);margin-top:4px;">
      View all trade-ins, see their agreed values, and jump into the refurb process.
    </p>

    <div class="table-wrap" style="margin-top:16px;">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Date</th>
            <th>Customer</th>
            <th>Contact</th>
            <th>Device</th>
            <th>Serial</th>
            <th>Valuation</th>
            <th>Agreed</th>
            <th>Refurb</th>
            <th>ID Image</th>
          </tr>
        </thead>
        <tbody id="tradeTbody">
          <tr><td colspan="10" style="padding:8px">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    function esc(s){ return String(s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&gt;','>':'&gt;','"':'&quot;'}[m]||m)); }
    function fmtMoney(v){
      if (v == null || v === '') return '–';
      const n = Number(v);
      if (Number.isNaN(n)) return '–';
      return '£' + n.toFixed(2);
    }

    let __toastTimer;
    function toast(msg, kind='err') {
      let t = document.getElementById('__toast');
      if (!t) {
        t = document.createElement('div');
        t.id = '__toast';
        Object.assign(t.style, {
          position:'fixed',left:'50%',top:'14px',transform:'translateX(-50%)',
          padding:'8px 14px',borderRadius:'999px',fontSize:'13px',
          background:'#a52828',color:'#fff',opacity:'0',transition:'opacity .2s',
          boxShadow:'0 8px 24px rgba(0,0,0,.35)',zIndex:9999,
        });
        document.body.appendChild(t);
      }
      t.style.background = kind==='ok' ? '#2c7a2c' : '#a52828';
      t.textContent = msg;
      t.style.opacity = '1';
      clearTimeout(__toastTimer);
      __toastTimer = setTimeout(()=> t.style.opacity='0', 1800);
    }

    async function loadTradeins() {
      const tbody = document.getElementById('tradeTbody');
      tbody.innerHTML = '<tr><td colspan="10" style="padding:8px">Loading…</td></tr>';

      try {
        const res = await fetch('/api/tradein');
        const items = await res.json();

        if (!Array.isArray(items) || !items.length) {
          tbody.innerHTML = '<tr><td colspan="10" style="padding:8px">No trade-ins yet.</td></tr>';
          return;
        }

        tbody.innerHTML = items.map(item => {
          const created = item.created_at
            ? new Date(item.created_at).toLocaleString('en-GB')
            : '';

          const contact = [
            item.customer_phone || '',
            item.customer_email || ''
          ].filter(Boolean).join(' · ');

          const refurbCell = item.refurb_id
            ? `#${item.refurb_id}`
            : '–';

          const idImg = item.id_image_path
            ? `<a href="${esc(item.id_image_path)}" target="_blank" rel="noopener">
                 <img src="${esc(item.id_image_path)}"
                      alt="ID"
                      style="max-width:60px;max-height:60px;object-fit:cover;border-radius:4px;border:1px solid rgba(255,255,255,0.15);">
               </a>`
            : '–';

          return `<tr>
            <td>${item.id}</td>
            <td>${esc(created)}</td>
            <td>${esc(item.customer_name)}</td>
            <td>${esc(contact)}</td>
            <td>${esc(item.device_desc)}</td>
            <td>${esc(item.serial)}</td>
            <td>${fmtMoney(item.valuation)}</td>
            <td>${fmtMoney(item.agreed_value)}</td>
            <td>${esc(refurbCell)}</td>
            <td>${idImg}</td>
          </tr>`;
        }).join('');

      } catch (err) {
        console.error(err);
        tbody.innerHTML =
          '<tr><td colspan="10" style="padding:8px;color:#900">Failed to load trade-ins.</td></tr>';
        toast('Failed to load trade-ins');
      }
    }

    window.addEventListener('DOMContentLoaded', loadTradeins);
  </script>
</body>
</html>

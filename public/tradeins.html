<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Trade-In List</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="/app.css">
</head>
<body>
    <div class="wrap">
    <aside id="sidebar"></aside>
  <main class="page">
    <h1>Trade-Ins</h1>
    <p style="color:var(--muted,#9aa);margin-top:4px;">
      View all trade-ins, see their agreed values, and jump into the refurb process.
    </p>

    <div class="table-wrap" style="margin-top:16px;">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Date</th>
            <th>Customer</th>
            <th>Contact</th>
            <th>Device</th>
            <th>Serial</th>
            <th>Valuation</th>
            <th>Agreed</th>
            <th>Refurb</th>
            <th>ID Image</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tradeTbody">
          <tr><td colspan="11" style="padding:8px">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </main>

  <script>
  const tbody = document.getElementById('tradeTbody');

  function esc(s){
    return String(s ?? '').replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function fmtMoney(v){
    if (v == null || v === '') return '–';
    const n = Number(v);
    if (Number.isNaN(n)) return '–';
    return '£' + n.toFixed(2);
  }

  let __toastTimer;
  function toast(msg, kind='err') {
    let t = document.getElementById('__toast');
    if (!t) {
      t = document.createElement('div');
      t.id = '__toast';
      Object.assign(t.style, {
        position:'fixed',left:'50%',top:'14px',transform:'translateX(-50%)',
        padding:'8px 14px',borderRadius:'999px',fontSize:'13px',
        background:'#a52828',color:'#fff',opacity:'0',transition:'opacity .2s',
        boxShadow:'0 8px 24px rgba(0,0,0,.35)',zIndex:9999,
      });
      document.body.appendChild(t);
    }
    t.style.background = kind==='ok' ? '#2c7a2c' : '#a52828';
    t.textContent = msg;
    t.style.opacity = '1';
    clearTimeout(__toastTimer);
    __toastTimer = setTimeout(()=> t.style.opacity='0', 1800);
  }

  // ---------- Modal helpers ----------
  function ensureModal(){
    let m = document.getElementById('editModal');
    if (m) return m;

    const html = `
      <div id="editModal" style="
        position:fixed; inset:0; background:rgba(0,0,0,.55);
        display:none; align-items:center; justify-content:center; z-index:9999;
      ">
        <div style="
          width:min(720px, 92vw);
          background:var(--panel, #111); border:1px solid var(--border, rgba(255,255,255,.12));
          border-radius:14px; padding:16px;
        ">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
            <div>
              <div style="font-weight:800;font-size:18px;">Edit trade-in</div>
              <div style="color:var(--muted,#9aa);font-size:13px;margin-top:2px;" id="editSub"></div>
            </div>
            <button type="button" id="editCloseBtn">✕</button>
          </div>

          <div class="form-grid" style="margin-top:14px;">
            <input type="hidden" id="edit_id">
            <input type="hidden" id="edit_customer_id">

            <label>Customer name</label>
            <input id="edit_customer_name" type="text">

            <label>Phone</label>
            <input id="edit_customer_phone" type="text">

            <label>Address</label>
            <input id="edit_customer_address" type="text">

            <label>Serial / IMEI</label>
            <input id="edit_serial" type="text">

            <label>Device description</label>
            <input id="edit_device_desc" type="text">

            <label>Valuation (£)</label>
            <input id="edit_valuation" type="number" step="0.01" min="0">

            <label>Agreed value (£)</label>
            <input id="edit_agreed_value" type="number" step="0.01" min="0">

            <div class="full" style="display:flex;gap:10px;justify-content:flex-end;margin-top:6px;">
              <button type="button" id="editCancelBtn">Cancel</button>
              <button type="button" class="primary" id="editSaveBtn">Save changes</button>
            </div>
          </div>

          <div id="editMsg" style="margin-top:10px;color:var(--muted,#9aa);font-size:13px;"></div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', html);

    m = document.getElementById('editModal');
    const close = () => (m.style.display = 'none');

    document.getElementById('editCloseBtn').addEventListener('click', close);
    document.getElementById('editCancelBtn').addEventListener('click', close);

    // click outside closes
    m.addEventListener('click', (e) => {
      if (e.target === m) close();
    });

    document.getElementById('editSaveBtn').addEventListener('click', saveEdit);

    return m;
  }

  function openEdit(item){
    const m = ensureModal();
    document.getElementById('editMsg').textContent = '';

    document.getElementById('edit_id').value = item.id;
    document.getElementById('edit_customer_id').value = item.customer_id || '';
    document.getElementById('editSub').textContent = `Trade-in #${item.id}`;

    document.getElementById('edit_customer_name').value = item.customer_name || '';
    document.getElementById('edit_customer_phone').value = item.customer_phone || '';
    document.getElementById('edit_customer_address').value = item.customer_address || item.customer_email || ''; // fallback if older rows
    document.getElementById('edit_serial').value = item.serial || '';
    document.getElementById('edit_device_desc').value = item.device_desc || '';
    document.getElementById('edit_valuation').value = item.valuation ?? '';
    document.getElementById('edit_agreed_value').value = item.agreed_value ?? '';

    m.style.display = 'flex';
  }

  async function saveEdit(){
    const id = Number(document.getElementById('edit_id').value);
    if (!id) return;

    const payload = {
      customer_name: document.getElementById('edit_customer_name').value.trim(),
      customer_phone: document.getElementById('edit_customer_phone').value.trim() || null,
      customer_address: document.getElementById('edit_customer_address').value.trim() || null,
      serial: document.getElementById('edit_serial').value.trim() || null,
      device_desc: document.getElementById('edit_device_desc').value.trim(),
      valuation: document.getElementById('edit_valuation').value === '' ? null : Number(document.getElementById('edit_valuation').value),
      agreed_value: document.getElementById('edit_agreed_value').value === '' ? null : Number(document.getElementById('edit_agreed_value').value),
    };

    try {
      const res = await fetch(`/api/tradein/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const text = await res.text();
      if (!res.ok) {
        let msg = text || 'Failed to update trade-in';
        try { msg = JSON.parse(text).error || msg; } catch {}
        throw new Error(msg);
      }

      toast('Trade-in updated ✅', 'ok');
      document.getElementById('editModal').style.display = 'none';
      await loadTradeins();
    } catch (e) {
      document.getElementById('editMsg').textContent = 'Error: ' + e.message;
    }
  }

  async function deleteTradein(id){
    if (!confirm(`Delete trade-in #${id}? This cannot be undone.`)) return;

    try {
      const res = await fetch(`/api/tradein/${id}`, { method: 'DELETE' });
      const text = await res.text();
      if (!res.ok) {
        let msg = text || 'Failed to delete trade-in';
        try { msg = JSON.parse(text).error || msg; } catch {}
        throw new Error(msg);
      }
      toast('Trade-in deleted ✅', 'ok');
      await loadTradeins();
    } catch (e) {
      toast(e.message || 'Failed to delete trade-in');
    }
  }

  // ---------- Load + render ----------
  async function loadTradeins() {
    tbody.innerHTML = '<tr><td colspan="11" style="padding:8px">Loading…</td></tr>';

    try {
      const res = await fetch('/api/tradein');
      const items = await res.json();

      if (!Array.isArray(items) || !items.length) {
        tbody.innerHTML = '<tr><td colspan="11" style="padding:8px">No trade-ins yet.</td></tr>';
        return;
      }

      tbody.innerHTML = items.map(item => {
        const created = item.created_at
          ? new Date(item.created_at).toLocaleString('en-GB')
          : '';

        const contact = [
          item.customer_phone || '',
          item.customer_address || ''
        ].filter(Boolean).join(' · ');

        const refurbCell = item.refurb_id
  ? `<a href="/refurb/${item.refurb_id}" target="_blank" rel="noopener" class="mono" style="text-decoration:underline;">
       #${item.refurb_id}
     </a>`
  : '–';

        const idImg = item.id_image_path
          ? `<a href="${esc(item.id_image_path)}" target="_blank" rel="noopener">
               <img src="${esc(item.id_image_path)}"
                    alt="ID"
                    style="max-width:60px;max-height:60px;object-fit:cover;border-radius:4px;border:1px solid rgba(255,255,255,0.15);">
             </a>`
          : '–';

        return `<tr>
          <td>${item.id}</td>
          <td>${esc(created)}</td>
          <td>${esc(item.customer_name)}</td>
          <td>${esc(contact)}</td>
          <td>${esc(item.device_desc)}</td>
          <td>${esc(item.serial)}</td>
          <td>${fmtMoney(item.valuation)}</td>
          <td>${fmtMoney(item.agreed_value)}</td>
          <td>${esc(refurbCell)}</td>
          <td>${idImg}</td>
          <td class="right">
            <button type="button" class="editBtn" data-id="${item.id}">Edit</button>
            <button type="button" class="delBtn" data-id="${item.id}">Delete</button>
          </td>
        </tr>`;
      }).join('');

      // wire buttons
      tbody.querySelectorAll('.editBtn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = Number(btn.dataset.id);
          const item = items.find(x => Number(x.id) === id);
          if (item) openEdit(item);
        });
      });

      tbody.querySelectorAll('.delBtn').forEach(btn => {
        btn.addEventListener('click', () => deleteTradein(Number(btn.dataset.id)));
      });

    } catch (err) {
      console.error(err);
      tbody.innerHTML =
        '<tr><td colspan="11" style="padding:8px;color:#900">Failed to load trade-ins.</td></tr>';
      toast('Failed to load trade-ins');
    }
  }

  window.addEventListener('DOMContentLoaded', loadTradeins);
</script>
  <script src="/js/sidebar.js"></script>
</body>
</html>
